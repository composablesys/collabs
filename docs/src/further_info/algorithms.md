# Algorithms

## Replication Model

Our main package, `@collabs/collabs`, supports collaborative data structures that are a hybrid of op-based and state-based [Conflict-free Replicated Data Types (CRDTs)](https://crdt.tech/). More specifically, this is true of `@collabs/crdts` (a subset of `@collabs/collabs`) and [`CRuntime`](../api/collabs/classes/CRuntime.html).

> **Aside:** The other subset of `@collabs/collabs`, `@collabs/core`, is designed for more general replication models, but you'll have to implement your own [`IRuntime`](../api/core/interfaces/IRuntime.html) to use non-CRDTs with it.

When a `Collab` is used within `CRuntime`, [`Collab.send`](../api/collabs/classes/Collab.html#send) and [`Collab.receive`](../api/collabs/classes/Collab.html#receive) correspond to op-based CRDT usage. The `send` method sends a message in response to a CRDT operation, which is then delivered to all replicas' `receive` methods (including the sender's). `CRuntime` guarantees that each message will be delivered eventually, exactly once, and in causal order. Additionally, `CRuntime` attaches [`CRDTMessageMeta`](../api/collabs/interfaces/CRDTMessageMeta.html) to each received message, containing a global vector clock and other CRDT-themed metadata.

[`Collab.save`](../api/collabs/classes/Collab.html#save) and [`Collab.load`](../api/collabs/classes/Collab.html#load) correspond to state-based usage (plus ordinary saving and loading). The `save` method returns a saved state that can be sent to other replicas (or stored locally). Calling `load` on that saved state then performs a state-based merge. `CRuntime` attaches [`CRDTSavedStateMeta`](../api/collabs/interfaces/CRDTSavedStateMeta.html) to each saved state in `load`, containing local and remote vector clocks and other CRDT-themed metadata.

> **Aside:** To implement a custom CRDT, consider extending [`PrimitiveCRDT`](../api/collabs/classes/PrimitiveCRDT.html), which provides easy access to the above metadata.

> **Aside:** It is okay to implement a custom CRDT that is only op-based or only state-based, by leaving `save/load` or `send/receive` unimplemented (or partially implemented - e.g. for op-based, allow `load` to be called at the beginning of an app to load previous saved state, but not to merge in a remote state). You will just have to restrict your `CRuntime` usage to avoid calling the unimplemented methods - e.g., don't call [`CRuntime.save`](../api/collabs/classes/CRuntime.html#save)/[`CRuntime.load`](../api/collabs/classes/CRuntime.html#load) if the runtime contains a CRDT that is only op-based.

### References

- [Yjs's document updates](https://docs.yjs.dev/api/document-updates) use a similar hybrid op-based/state-based model, except its API does not distinguish between op-based messages and state-based states (both are just "updates").
- [Automerge's changes and saved states](https://automerge.org/docs/tsapi/index/) use the same hybrid op-based/state-based model.
- [Delta State Replicated Data Types](http://dx.doi.org/10.1016/j.jpdc.2017.08.003) (Paulo Sérgio Almeida, Ali Shoker, and Carlos Baquero) use a different hybrid of op-based and state-based CRDTs. Specifically, they augment state-based CRDTs with "deltas": incremental states that are still mergeable but that only describe a single operation, like an op-based message. In contrast, we allow arbitrary op-based messages, not just deltas that are themselves valid states.
- [Making Operation-based CRDTs Operation-based](https://doi.org/10.1007/978-3-662-43352-2_11) (Carlos Baquero, Paulo Sérgio Almeida, Ali Shoker) describes _Pure Op-based CRDTs_: op-based CRDTs in which the sent message is a function of the operation only, not the CRDT's current state. All of our CRDTs except list types are pure. This is possible due to [`CRDTMessageMeta`](../api/collabs/interfaces/CRDTMessageMeta.html), which implements the "tag" portion of the paper's _Tagged Reliable Causal Broadcast_.
- We use [vector clocks](https://en.wikipedia.org/wiki/Vector_clock) to track the causal order and as provided metadata. To keep network messages small, though, we don't send the whole vector clock in each message. Instead, we only send "necessary" vector clock entries: a minimal set of causal dependencies (like [Martin Kleppmann describes for Automerge](https://github.com/automerge/automerge-classic/issues/28)), and any entries accessed by the sender's own `Collab.receive` function (which usually suffice for _all_ receivers - e.g., see the comment in [`CMultiValueMap.set`](https://github.com/composablesys/collabs/blob/master/crdts/src/map/c_multi_value_map.ts)'s implementation).

## Built-in `Collab`s

Our [built-in `Collab`s](../guide/built_in_collabs.html) are all [Conflict-free Replicated Data Types (CRDTs)](https://crdt.tech/). They use CRDT algorithms from (or inspired by) various sources, shown in the table below.

| **Collab**                                                                                                                               | **Algorithm**                                                                                                      | **References**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | **Comments**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| ---------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| [`CBoolean`](../api/collabs/classes/CBoolean.html)                                                                                       | Enable-Wins Flag, or Disable-Wins Flag with option `{ winner: false }`                                             | [Pure Operation-based Replicated Data Types](http://arxiv.org/abs/1710.04469v1), Carlos Baquero, Paulo Sérgio Almeida, and Ali Shoker                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [`CCounter`](../api/collabs/classes/CCounter.html)                                                                                       | State-based PN-Counter                                                                                             | [A Comprehensive Study of Convergent and Commutative Replicated Data Types](https://hal.inria.fr/inria-00555588/document/), Marc Shapiro, Nuno Preguiça, Carlos Baquero, and Marek Zawirski                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Messages only send the added value and sender ID, not the entire state. That is similar to the delta-CRDT Counter from [Delta State Replicated Data Types](http://dx.doi.org/10.1016/j.jpdc.2017.08.003), Paulo Sérgio Almeida, Ali Shoker, and Carlos Baquero.                                                                                                                                                                                                                                                                                                            |
| [`CLazyMap`](../api/collabs/classes/CLazyMap.html)                                                                                       | Riak Map without deletions                                                                                         | [Riak Data Types: Maps](https://docs.riak.com/riak/kv/2.2.3/developing/data-types/maps.1.html). Similar CRDT-valued maps appear in [Logic and Lattices for Distributed Programming](https://doi.org/10.1145/2391229.2391230), Neil Conway, William R. Marczak, Peter Alvaro, Joseph M. Hellerstein, and David Maier; [LVars: Lattice-based Data Structures for Deterministic Parallelism](https://doi.org/10.1145/2502323.2502326), Lindsey Kuper and Ryan R. Newton; and [Composition of State-based CRDTs](http://haslab.uminho.pt/cbm/files/crdtcompositionreport.pdf), Carlos Baquero, Paulo Sérgio Almeida, Alcino Cunha and Carla Ferreira. | Like the Riak Map, there is a single value CRDT per key that implicitly always exists, all operations on that value are merged, and a key is present if and only if its value CRDT is in a nontrivial state (determined by [`Collab.canGC`](../api/collabs/classes/Collab.html#canGC)). Unlike the Riak map, we do not allow delete-key operations, which in Riak would perform an observed-reset operation on the value.                                                                                                                                                  |
| [`CList`](../api/collabs/classes/CList.html)                                                                                             | List-with-Move                                                                                                     | [Moving Elements in List CRDTs](https://doi.org/10.1145/3380787.3393677), Martin Kleppmann                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | In addition to position, the register has an `isPresent` field, used for archive/restore. Also, we use our [`CSet`](../api/collabs/classes/CSet.html) instead of an Add-Wins Set.                                                                                                                                                                                                                                                                                                                                                                                          |
| [`CMap`](../api/collabs/classes/CMap.html)                                                                                               | [`CValueMap`](../api/collabs/classes/CValueMap.html) with values from a [`CSet`](../api/collabs/classes/CSet.html) |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Inspired by how [Yjs's `Y.Map`](https://docs.yjs.dev/api/shared-types/y.map) handles values that are themselves shared types.                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| [`CMultiValueMap`](../api/crdts/classes/CMultiValueMap.html)                                                                             | Multi-Value Register per key                                                                                       | [A Comprehensive Study of Convergent and Commutative Replicated Data Types](https://hal.inria.fr/inria-00555588/document/), Marc Shapiro, Nuno Preguiça, Carlos Baquero, and Marek Zawirski                                                                                                                                                                                                                                                                                                                                                                                                                                                       | A key is present whenever its Multi-Value Register has nonzero conflicting values; the [`delete`](../api/crdts/classes/CMultiValueMap.html#delete) operation just clears the (causally prior) conflicting values. For state-based merging of a saved state, we delete conflicts based on a vector clock instead of tombstones, following [An Optimized Conflict-free Replicated Set](https://hal.inria.fr/file/index/docid/738680/filename/RR-8083.pdf), Annette Bieniusa, Marek Zawirski, Nuno Preguiça, Marc Shapiro, Carlos Baquero, Valter Balegas, and Sérgio Duarte. |
| [`CObject`](../api/collabs/classes/CObject.html)                                                                                         | Similar to `CLazyMap`, but with a fixed set of keys (the child names).                                             | See `CLazyMap` references.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | We have not seen an identical "CRDT object" idea in the literature, but the idea and semantics are obvious (multiple independent CRDTs side-by-side, keyed by name).                                                                                                                                                                                                                                                                                                                                                                                                       |
| [`CTotalOrder`](../api/crdts/classes/CTotalOrder.html) and [`LocalList`](../api/collabs/classes/LocalList.html) (used in all list types) | Tree-Fugue List CRDT                                                                                               | [The Art of the Fugue: Minimizing Interleaving in Collaborative Text Editing](https://arxiv.org/abs/2305.00583), Matthew Weidner, Joseph Gentle, and Martin Kleppmann.                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | Blog post: [Fugue: A Basic List CRDT](https://mattweidner.com/2022/10/21/basic-list-crdt.html). As an optimization, we use "waypoints" as described in [`CTotalOrder`'s doc header](../api/crdts/classes/CTotalOrder.html); those are inspired by [Yjs's items](https://blog.kevinjahns.de/are-crdts-suitable-for-shared-editing/).                                                                                                                                                                                                                                        |
| [`CRichText`](../api/collabs/classes/CRichText.html)                                                                                     | Peritext                                                                                                           | [Peritext: A CRDT for Collaborative Rich Text Editing](https://doi.org/10.1145/3555644), Geoffrey Litt, Sarah Lim, Martin Kleppmann, and Peter van Hardenberg.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | The semantics are substantially similar to Peritext's, but we use somewhat different internal representations. For example, we store formatting span starts and ends in a separate [`LocalList`](../api/collabs/classes/LocalList.html) instead of inline with the text (which is stored in a [`CValueList`](../api/collabs/classes/CValueList.html)).                                                                                                                                                                                                                     |
| [`CSet`](../api/collabs/classes/CSet.html)                                                                                               | Unique Set of CRDTs                                                                                                | [Designing Data Structures for Collaborative Apps](https://mattweidner.com/2022/02/10/collaborative-data-design.html), Matthew Weidner. The Unique Set (U-Set) with non-CRDT values is from [A Comprehensive Study of Convergent and Commutative Replicated Data Types](https://hal.inria.fr/inria-00555588/document/), Marc Shapiro, Nuno Preguiça, Carlos Baquero, and Marek Zawirski.                                                                                                                                                                                                                                                          | If a value is deleted concurrently to an operation on that value, the delete "wins" and the operation is ignored. That "deleting" semantics is from [Yjs's `Y.Array`](https://docs.yjs.dev/api/shared-types/y.map) shared type.                                                                                                                                                                                                                                                                                                                                            |
| [`CValueMap`](../api/collabs/classes/CValueMap.html)                                                                                     | [Aggregator](../api/collabs/interfaces/Aggregator.html) of a Multi-Value Register per value                        | [Eventually Consistent Register Revisited](http://dx.doi.org/10.1145/2911151.2911157), Marek Zawirski, Carlos Baquero, Annette Bieniusa, Nuno Preguiça, and Marc Shapiro                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | The default aggregator returns the conflicting value with least [`senderID`](../api/collabs/interfaces/MultiValueMapItem.html#senderID). That is similar in spirit to a Last-Writer-Wins (LWW) Map - pick an arbitrary causally-maximal value - but it does not use an actual timestamp.                                                                                                                                                                                                                                                                                   |
| [`CValueSet`](../api/collabs/classes/CValueSet.html)                                                                                     | Add-Wins Set / Observed-Remove Set                                                                                 | [An Optimized Conflict-free Replicated Set](https://hal.inria.fr/file/index/docid/738680/filename/RR-8083.pdf), Annette Bieniusa, Marek Zawirski, Nuno Preguiça, Marc Shapiro, Carlos Baquero, Valter Balegas, and Sérgio Duarte                                                                                                                                                                                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| [`CVar`](../api/collabs/classes/CVar.html)                                                                                               | [Aggregator](../api/collabs/interfaces/Aggregator.html) of a Multi-Value Register                                  | [Eventually Consistent Register Revisited](http://dx.doi.org/10.1145/2911151.2911157), Marek Zawirski, Carlos Baquero, Annette Bieniusa, Nuno Preguiça, and Marc Shapiro                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | The default aggregator returns the conflicting value with least [`senderID`](../api/collabs/interfaces/MultiValueMapItem.html#senderID). That is similar in spirit to a Last-Writer-Wins (LWW) Register - pick an arbitrary causally-maximal value - but it does not use an actual timestamp.                                                                                                                                                                                                                                                                              |
